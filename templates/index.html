<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <style>
        :root{
            --bg: #ffffff;
            --text: #212529;
            --card-bg: #f8f9fa;
            --chat-bg: #ffffff;
            --chat-text: #212529;
        }
        .dark-mode{
            --bg: #0d1117;
            --text: #e6edf3;
            --card-bg: #0f1720;
            --chat-bg: #071018;
            --chat-text: #e6edf3;
        }
        body{background:var(--bg); color:var(--text);} 
        .card {background:var(--card-bg);}
        .chat-window{background:var(--chat-bg); color:var(--chat-text); padding:1rem; border-radius:6px; max-height:60vh; overflow:auto}
        .theme-toggle{position:relative; top:-6px; margin-left:8px}
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex align-items-center my-4">
            <h1 class="m-0">Ollama Chat</h1>
            <button id="themeToggle" class="btn btn-sm btn-outline-secondary theme-toggle">Dark</button>
        </div>

        <div class="card mx-3">
            <div class="card-body">
                <div class="chat-window" id="chatWindow">
                    <p class="text-muted">Type your message and press Enter!</p>
                </div>
            </div>
        </div>

        <div class="card mx-3">
            <div class="card-body">
                <textarea id="messageInput" class="form-control" rows="4" placeholder="Enter your message (Press Enter to send, Shift+Enter for newline)"></textarea>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/purify.min.js') }}"></script>
    <script>
        $(document).ready(function() {
            // Theme init: apply saved theme or default
            function applyTheme(theme){
                if(theme === 'dark'){
                    $('body').addClass('dark-mode');
                    $('#themeToggle').text('Light');
                } else {
                    $('body').removeClass('dark-mode');
                    $('#themeToggle').text('Dark');
                }
            }
            var saved = localStorage.getItem('theme') || 'light';
            applyTheme(saved);
            $('#themeToggle').click(function(){
                var cur = $('body').hasClass('dark-mode') ? 'dark' : 'light';
                var next = cur === 'dark' ? 'light' : 'dark';
                applyTheme(next);
                localStorage.setItem('theme', next);
            });
            // Enter-to-send: Shift+Enter inserts newline, Enter sends
            function sendMessage() {
                var message = $("#messageInput").val();
                if (!message || !message.trim()) return;
                // Append locally and trim to last 50 (client-side storage)
                messages.push({role: 'user', text: message});
                if (messages.length > 50) messages = messages.slice(-50);
                saveMessages();
                renderMessages();

                $("#messageInput").val(""); // Clear the input

                // Send the last 15 messages as context to the server
                var sendMessages = messages.slice(-15);

                $.ajax({
                    url: "/get_response",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ prompt: message, session_id: sessionId, messages: sendMessages }),
                    success: function(response) {
                        var assistantText = response.response || '';
                        // Append assistant reply locally and re-render
                        messages.push({role: 'assistant', text: assistantText});
                        if (messages.length > 50) messages = messages.slice(-50);
                        saveMessages();
                        renderMessages();
                    },
                    error: function(error) {
                        console.error("Error:", error);
                    }
                });
            }

            // Send on Enter (without Shift). Allow Shift+Enter for newlines.
            $("#messageInput").on('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Message array stored in localStorage to avoid server-side memory usage
            var sessionId = localStorage.getItem('session_id');
            if (!sessionId) {
                if (window.crypto && crypto.randomUUID) {
                    sessionId = crypto.randomUUID();
                } else {
                    sessionId = 's-' + Date.now() + '-' + Math.floor(Math.random()*1000000);
                }
                localStorage.setItem('session_id', sessionId);
            }

            var messages = JSON.parse(localStorage.getItem('messages') || '[]');

            function saveMessages() {
                localStorage.setItem('messages', JSON.stringify(messages));
            }

            function renderMessages() {
                $('#chatWindow').empty();
                if (messages.length === 0) {
                    $('#chatWindow').append($('<p>').addClass('text-muted').text('Type your message and press Enter!'));
                    return;
                }
                messages.forEach(function(m){
                    var label = m.role === 'user' ? 'You:' : 'Ollama:';
                    if (m.role === 'assistant') {
                        var rendered = marked.parse(m.text || '');
                        var safe = DOMPurify.sanitize(rendered);
                        var wrapper = $('<div>').append($('<strong>').text(label + ' '));
                        wrapper.append($(safe));
                        $('#chatWindow').append($('<p>').append(wrapper));
                    } else {
                        $('#chatWindow').append($('<p>').append($('<strong>').text(label + ' ')).append(document.createTextNode(m.text)));
                    }
                });
                $('#chatWindow').scrollTop($('#chatWindow')[0].scrollHeight);
            }

            renderMessages();

            // Note: click handler removed; sendMessage() handles sending on Enter.
        });
    </script>
</body>
</html>
